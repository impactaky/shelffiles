# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Setup and Build
```bash
# Setup development environment (uses argc for CLI parsing)
./setup.sh [--no-root]

# Build packages using Nix
nix build

# Build in Docker environment (fallback when Nix unavailable)
./utils/build_nix_in_docker.sh
```

### Testing
```bash
# Run complete test suite via Docker
docker build -f test/Dockerfile .

# Run individual shell tests (requires BATS)
bats test/test/bashrc_load.bats
bats test/test/zshrc_load.bats
bats test/test/fishrc_load.bats
```

### Environment Usage
```bash
# Enter shell-specific environments
./entrypoint/bash   # Bash with XDG config loading
./entrypoint/zsh    # Zsh with ZDOTDIR configuration
./entrypoint/fish   # Fish with config.fish loading
```

### Package Management
```bash
# Edit packages.nix to modify available packages
# Then rebuild environment
nix build
```

## Architecture Overview

Shelffiles integrates three core systems:

### 1. Nix Flakes Layer
- `flake.nix`: Defines multi-architecture package environment
- `packages.nix`: User-customizable package list
- Creates reproducible `buildEnv` across Linux/macOS on x86_64/aarch64

### 2. XDG Environment Management
- `entrypoint/env.sh`: Sets XDG base directory variables pointing to repository subdirectories
- Uses `${PATH_ID}` (user/group-specific) to prevent conflicts between users
- Automatically creates `cache/`, `share/`, `state/` directories as needed

### 3. Shell Integration Layer
- `entrypoint/{bash,zsh,fish}`: Shell-specific launchers
- Each sets appropriate shell variables (ZDOTDIR for zsh, HISTFILE for bash)
- Falls back to `launch_in_bwrap.sh` containerized execution when Nix packages unavailable

### Containerization Fallback
- `launch_in_bwrap.sh`: Uses bubblewrap to create isolated environment
- Mounts repository's `/nix` directory into container for package access
- Provides security and portability when direct Nix execution not available

## Testing Infrastructure

### BATS Framework
- Tests verify each shell correctly loads configurations from `config/` directories
- Test configs set environment variables (`SHELFFILES_*_TEST="loaded"`) to verify loading
- Docker-based CI ensures reproducible testing environment

### CI/CD Workflows
- **Docker Build**: Tests complete setup in clean environment with layer caching
- **Lint**: Pre-commit hooks (shellcheck, trailing whitespace, YAML validation, hadolint)
- **Argc Verification**: Ensures `setup.sh` stays synchronized with argc generation
- **Claude Code**: AI assistance triggered by @claude mentions

## Development Considerations

### Argc Integration
- `setup.sh` generated by argc CLI framework - do not manually edit argc-generated sections
- Regenerate with: `argc --argc-build setup.sh > setup.sh`
- CI enforces this requirement via checksum verification

### Git Integration Features
- `example/config/git/`: Contains filter configuration to exclude "shelffiles" lines from devcontainer.json commits
- Enables local devcontainer customization without affecting repository

### XDG Compliance
- Configuration files automatically discovered by applications using XDG specification
- User-specific paths prevent conflicts in multi-user environments
- Standard directory hierarchy: `config/`, `cache/`, `share/`, `state/`

## Build Artifacts and Dependencies

### Key Dependencies
- **Nix** with flakes support (primary dependency)
- **Docker** (testing and fallback builds)
- **Bubblewrap** (containerized execution)
- **Argc** (CLI argument parsing generation)

### Generated Artifacts
- `result/`: Nix build output symlink
- `result_docker/`: Docker-based build output
- `cache/`, `share/`, `state/`: XDG directories (git-ignored)
- `/nix`: Copied Nix store for containerized environments (git-ignored)